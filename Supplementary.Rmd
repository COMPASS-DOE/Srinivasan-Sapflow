---
title: "Supplementary Data"
author: "RVS & KAM"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---


```{r Load Packages, message = FALSE, warning = FALSE}

.packages = c("tidyr", "ggplot2", "dplyr", "lme4",
              "AICcmodavg", "MuMIn", "pbkrtest", "readr",
              "lubridate", "car", "parallel", "data.table",
              "blmeco", "lsmeans", "patchwork", "viridis",
              "forcats", "ggpmisc", "stringr", "e1071", "ggpubr")

.inst <- .packages %in% installed.packages()
if(length(.packages[!.inst]) > 0) install.packages(.packages[!.inst])

#Attach packages
sapply(.packages, require, character.only=TRUE)
```

```{r, message = FALSE, warning = FALSE}
setwd("/Users/radha/Documents/TEMPEST_Sapflow_Analysis")

#final_tmp_data <- readRDS("final_tmp_data.rds")
final_data <- readRDS("/Users/radha/Documents/TEMPEST_Sapflow_Analysis/final_data.rds")
data <- readRDS("/Users/radha/Documents/TEMPEST_Sapflow_Analysis/Sapflow_BACI.rds")

```

# EC Plots & BACI analysis

All species, all plots- EC comparison between plots from 2021-2025, midday sapflow

```{r EC Plots, message = FALSE, warning = FALSE}

# packages from main Rmd already loaded
library(zoo)

# isolate soil data and summarise
data %>%
  dplyr::select(Year, TIMESTAMP, Plot,
                ec_avg, ec_sd,
                swc_avg) %>%
  mutate(Date = as_date(date(TIMESTAMP)),
         Hour = hour(TIMESTAMP)) %>%
  filter(Hour <= 14, Hour >= 11) %>%
  na.omit() %>%
  group_by(Year, Date, Plot) %>%
  summarise(soil_ec_avg = mean(ec_avg),
            ec_error = sd(ec_avg),
            soil_vwc_avg = mean(swc_avg)) %>%
  ungroup() -> soil_data

# created rolled mean of EC for plotting
soil_data %>%
  dplyr::select(Year, Plot, Date, soil_ec_avg) %>%
  group_by(Plot) %>%
  arrange(Date) %>%
  mutate(ec_rolled = rollmean(soil_ec_avg,
                              k = 3,
                              align = "center",
                              fill = NA)) -> ec_rolled
# pretty plot of EC data
soil_data %>%
  filter(Date > "2021-04-01") %>%
  #optional, gets ride of little squiggle at the begining of '21
ggplot(aes(Date, soil_ec_avg, color = Plot)) +
  geom_point(alpha=0.5) +
  geom_errorbar(aes(ymin = soil_ec_avg - ec_error,
                    ymax = soil_ec_avg + ec_error)) +
  geom_line(data = ec_rolled %>%
              filter(Date > "2021-04-01"),
            aes(Date, ec_rolled)) +
  scale_color_viridis_d(option = "mako",
                        begin = 0.3,
                        end = 0.7) + theme_bw() +
  theme(legend.position = "bottom") +
  ylab("Soil Electrical Conductivity (\u03bcS cm\u207b\u00b9)")

# analyze long-term BACI impact on EC and VWC
soil_data %>%
  filter(! Year %in% c(2022, 2023, 2024),
         month(Date) == 6) -> soil_BACI_data

# here Year is acting as "BA"
ec_2way <- aov(soil_ec_avg ~ Year*Plot,
                   data = soil_BACI_data)
#calculate estimated marginal means
ec_emm <- emmeans(ec_2way, ~ Plot|Year)
emm_2wayA <- as.data.frame(ec_emm)
#shows pairwise tests of 2021 vs 2025
contrasts <- contrast(ec_emm, interaction = "pairwise")
summary(contrasts)

#setting a width for offsets below
dodge_width <- 0.25

#plot of 21 vs 25 EMM with 95% CI for soil EC
ggplot(emm_2wayA, aes(x = Year, y = emmean, color = Plot)) +
  geom_point(size = 3, position = position_dodge(width = dodge_width)) +
  geom_errorbar(
    aes(ymin = lower.CL, ymax = upper.CL),
    width = 0.25,  
    position = position_dodge(width = dodge_width)) +
  geom_line(
    aes(group = Plot),
    position = position_dodge(width = dodge_width),
    linetype = "dashed") +
  scale_color_viridis_d(option = "mako",
                        begin = 0.3,
                        end = 0.7) +
  theme_minimal() +
  labs(
    y = "EMM",
    x = "Year",
    title = "Long-Term BACI for Soil EC") +
  theme(
    strip.text = element_text(face = "bold"),
    legend.title = element_text(face = "bold"))

```

EMM Pairwise comparisons for 2021 and 2025 demonstrate statistically significant differences for all except post-treatment control-saltwater comparison.
BACI plot demonstrates much larger EMM increase in soil EC for saltwater plot

# VWC Plots & BACI analysis

All species, all plots- VWC comparison between plots from 2021-2025, midday sapflow

```{r VWC Plots, message = FALSE, warning = FALSE}
# same for moisture content
vwc_2way <- aov(soil_vwc_avg ~ Year*Plot,
               data = soil_BACI_data)

vwc_emm <- emmeans(vwc_2way, ~ Plot|Year)
emm_2wayB <- as.data.frame(vwc_emm)

contrasts <- contrast(vwc_emm, interaction = "pairwise")
summary(contrasts)

# VWC plot
ggplot(emm_2wayB, aes(x = Year, y = emmean, color = Plot)) +
  geom_point(size = 3, position = position_dodge(width = dodge_width)) +
  geom_errorbar(
    aes(ymin = lower.CL, ymax = upper.CL),
    width = 0.25,  
    position = position_dodge(width = dodge_width)) +
  geom_line(
    aes(group = Plot),
    position = position_dodge(width = dodge_width),
    linetype = "dashed") +
  scale_color_viridis_d(option = "mako",
                        begin = 0.3,
                        end = 0.7) +
  theme_minimal() +
  labs(
    y = "EMM",
    x = "Year",
    title = "Long-Term BACI for Soil VWC") +
  theme(
    strip.text = element_text(face = "bold"),
    legend.title = element_text(face = "bold"))                                                                                                                                                                                         
```

Pairwise comparison for 2021 and 2025; freshwater-saltwater VWC difference is not statistically significant for either year. 
BACI plot demonstrating increase in soil VWC EMM for all treatments. 

# PAR plots

PAR averaged hourly for 2 weeks pre and post-flood. 

```{r List of TEMPEST Events, message = FALSE, warning = FALSE}
#TEMPEST EVENTS
tempest_events <- bind_rows(
  tibble( Year = 2021, flood_start = "2021-06-12", flood_end = "2021-06-12"), #average date = June 12
  tibble( Year = 2022, flood_start = "2022-06-22", flood_end = "2022-06-22"), #June 22
  tibble( Year = 2023, flood_start = "2023-06-06", flood_end = "2023-06-07"), #June 6, 7
  tibble( Year = 2024, flood_start = "2024-06-11", flood_end = "2024-06-13"), #June 11, 12, 13
  tibble( Year = 2025, flood_start = "2025-06-12", flood_end = "2025-06-12")) #No TEMPEST event; averaging

tempest_events %>%
  mutate(flood_start = ymd(flood_start),
         flood_end = ymd(flood_end)) %>%
  mutate (Year = as.factor(Year)) -> events

#window of data to look at for BACI analysis
window <- days(15)
```

```{r PAR Plot, message = FALSE, warning = FALSE}

data %>%
  mutate(Date = as.Date(TIMESTAMP),
         Hour = hour(TIMESTAMP), 
         Year = as.factor(Year)) %>% 
  dplyr::select(PAR, Date, Hour, Year) -> par

par %>%
  left_join(events, by = "Year") %>% 
  group_by(Year) %>%
  filter(
    Date >= flood_start - window,
    Date <= flood_end   + window
  ) %>%
  mutate(BA = ifelse(Date > flood_end, "After", "Before"),
         BA = as.factor(BA)) %>%
  group_by(Hour, Date, Year, BA, flood_start, flood_end) %>%
  summarise(par_avg = mean(PAR)) %>%
  filter(par_avg >=500) %>%
  drop_na(par_avg) %>%
  ungroup() -> par_1

par_1 %>%
  group_by(Year) %>%
  mutate(Day = ifelse(BA == "Before",
                      - as.numeric(flood_start - Date),
                      as.numeric(Date - flood_end))) %>%
  mutate(BA = as.character(BA),
         BA = ifelse(Year == 2021, "Before", BA),
         BA = ifelse(Year == 2025, "After", BA),
         BA = as.factor(BA)) -> par_2

ggplot(par_2, aes(Day, par_avg, shape = BA)) +
  geom_point(size = 2.5, color = "darkgreen") + facet_grid("Year", scales = "free")
```

# Tulip Poplar BACI Analysis

## Whole growing season, saltwater and control plots, 7 am- 7pm 
## BACI models and AIC comparison table 
```{r, message = FALSE, warning = FALSE}

#growing season from May 15th - October 1st
#I'm sure there's a better way to do this but
growing_szn <- bind_rows(
  tibble(Year = 2021, szn_start = "2021-05-15", szn_end = "2021-10-01",flood_start = "2021-06-12", flood_end = "2021-06-12"),
  tibble(Year = 2022, szn_start = "2022-05-15", szn_end = "2022-10-01", flood_start = "2022-06-22", flood_end = "2022-06-22"),
  tibble(Year = 2023, szn_start = "2023-05-15", szn_end = "2023-10-01", flood_start = "2023-06-06", flood_end = "2023-06-07"),
  tibble(Year = 2024, szn_start = "2024-05-15", szn_end = "2024-10-01", flood_start = "2024-06-11", flood_end = "2024-06-13"),
  tibble(Year = 2025, szn_start = "2025-05-15", szn_end = "2025-10-01", flood_start = "2025-06-12", flood_end = "2025-06-12"))

growing_szn %>%
  mutate(szn_start = ymd(szn_start),
         szn_end = ymd(szn_end),
         flood_start = ymd(flood_start),
         flood_end = ymd(flood_end)) -> season

#add in filtering step so that growing-season BACI has the same input data

filtered_data %>% #first we remove outlier values
mutate(Hour = hour(TIMESTAMP),
       Date = date(TIMESTAMP),
       doy = yday(Date)) %>%
  filter(doy > 99 & doy < 301, #growing season
         Hour <= 14, Hour > 11, #midday
         `F` > 0, ! is.na(Species)) -> target_data #remove obviously unusuable data

# Calculating thresholds for sapflow outliers.
thresholds <- target_data %>% 
  group_by(Species, Plot, Year) %>% #allows for annual, plot, and species specific values
  summarize(upper_threshold = quantile(`F` , 0.95))

# Remove values above that threshold
filtered_data <- target_data %>%
  left_join(thresholds, by = c("Species", "Plot", "Year")) %>%
  mutate(Outlier_F = ifelse(F > upper_threshold, "Outlier", "Non-Outlier")) %>%
  filter(Outlier_F == "Non-Outlier")



filtered_data %>%
  dplyr::select(Year, Species, ID, TIMESTAMP, Plot, `F` ,
                soil_vwc_15cm, soil_ec_15cm, swc_sd, ec_sd, PAR) %>%
  mutate(Date = as_date(date(TIMESTAMP)),
         Hour = hour(TIMESTAMP)) %>%
  left_join(season) %>% 
  group_by(Year) %>%
  #mutate(data_start = flood_start - window,
  #       data_end = flood_end + window) %>%
  filter(Date > szn_start & Date < szn_end,
         Hour <= 19, Hour >= 7,
         F <= 0.005, F >= 0,
         (PAR >= 500 | is.na(PAR)),
         Plot != "Freshwater",
         Species == "Tulip Poplar") %>%
  ungroup() -> tulip_salt  

#sapflow, soil ec, soil vwc grouped by day and averaged
#should we change this to hourly averages for ec?
tulip_salt %>%
  group_by(Year) %>%
  mutate(BA = ifelse(Date > flood_end, "After", "Before"),
         Year = as.factor(Year),
         ID = as.factor(ID),
         BA = as.factor(BA),
         Plot = as.factor(Plot)) %>%
  group_by(Date, Plot, ID, Year, BA, flood_start, flood_end, szn_start, szn_end) %>%
  summarise(F_avg = mean(`F` , na.rm = TRUE),
            soil_ec_avg = mean(soil_ec_15cm, na.rm = TRUE), 
            soil_vwc_avg = mean(soil_vwc_15cm, na.rm = TRUE),
            n = n()) %>%
  ungroup() -> tsb_1

tsb_1 %>%
  group_by(Year) %>%
  mutate(Day = ifelse(BA == "Before",
                      - as.numeric(flood_start - Date),
                      as.numeric(Date - flood_end))) %>%
  mutate(BA = as.character(BA)) %>%
  mutate(BA = ifelse(Year == 2021, "Before", BA),
         BA = ifelse(Year == 2025, "Before", BA)) -> tsb_2
```



```{r BACI Model, message = FALSE, warning = FALSE}

model.int.og <- lmer(F_avg ~ BA*Plot +
                        (1|ID) + (1|Year) + (1|ID:Year),
                      data = tsb_2)

model.noint.og <- lmer(F_avg ~ BA + Plot +
                          (1|ID) + (1|Year) + (1|ID:Year),
                        data = tsb_2)

og.refdist <- PBrefdist(largeModel = model.int.og, 
                        smallModel = model.noint.og, 
                        nsim = 100)

og.compar <- PBmodcomp(largeModel = model.int.og, 
                       smallModel = model.noint.og,
                       ref = og.refdist)

og.compar
Anova(model.int.og, type = "III")
```

Both the likelihood ratio test and the parametric bootstrap test show statistical significance for the effect of BACI interaction term on observed differences in sapflow.

As a proxy for the increase in flooding intensity with each year, we include soil electrical conductivity into the model. Note that soil EC is an indicator of salt accumulation in soil from brackish water application. 

```{r Soil EC BACI, message = FALSE, warning = FALSE}
#BACI with just soil EC to account for pre-existing differences: 
model.int.ec <- lmer(soil_ec_avg ~ BA*Plot +
                      (1|Year),
                      data = tsb_2)

model.noint.ec <- lmer(soil_ec_avg ~ BA + Plot +
                      (1|Year),
                      data = tsb_2)

ec.refdist <- PBrefdist(largeModel = model.int.ec, 
                        smallModel = model.noint.ec, 
                        nsim = 100)

ec.compar <- PBmodcomp(largeModel = model.int.ec, 
                       smallModel = model.noint.ec,
                       ref = ec.refdist)
ec.compar
Anova(model.int.ec, type = "III")

```
Both the liklihood ratio test and parametric bootstrap test show statistical significance for the effect of the BACI interaction on observed differences in EC. 

```{r BACI plus EC, message = FALSE, warning = FALSE}
model.int.ec <- lmer(F_avg ~ BA*Plot + soil_ec_avg +
                      (1|ID) + (1|Year) + (1|ID:Year),
                      data = tsb_2)

model.noint.ec <- lmer(F_avg ~ BA + Plot + soil_ec_avg +
                        (1|ID) + (1|Year) + (1|ID:Year),
                        data = tsb_2)

ec.refdist <- PBrefdist(largeModel = model.int.ec, 
                        smallModel = model.noint.ec, 
                        nsim = 100)

ec.compar <- PBmodcomp(largeModel = model.int.ec, 
                       smallModel = model.noint.ec,
                       ref = ec.refdist)
ec.compar
Anova(model.int.ec, type = "III")
```
Both the liklihood ratio test and the parametric boostrap test show that soil ec and the BACI interaction term have statistically significant effects on the observed differences in sapflow. When soil ec is accounted for in the model, the BACI interaction term is more significant than when only the interaction term is included. 

