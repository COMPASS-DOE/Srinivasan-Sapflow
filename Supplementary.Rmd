---
title: "Supplementary Data"
author: "RVS & KAM"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

# Soil EC and VWC tests

```{r Load Packages, message = FALSE, warning = FALSE}

.packages = c("tidyr", "ggplot2", "dplyr", "lme4",
              "AICcmodavg", "MuMIn", "pbkrtest", "readr",
              "lubridate", "car", "parallel", "data.table",
              "blmeco", "lsmeans", "patchwork", "viridis",
              "forcats", "ggpmisc", "stringr", "e1071",
              "ggpubr", "zoo")

.inst <- .packages %in% installed.packages()
if(length(.packages[!.inst]) > 0) install.packages(.packages[!.inst])

#Attach packages
sapply(.packages, require, character.only=TRUE)
```

```{r, message = FALSE, warning = FALSE}

data <- readRDS("Sapflow_BACI.rds")

```

## EC Plot & BACI

Soil electrical conductivity at 15 cm depth comparison across plots from 2021-2025

```{r EC, message = FALSE, warning = FALSE}

# isolate soil data and summarize
data %>%
  dplyr::select(Year, TIMESTAMP, Plot,
                ec_avg, ec_sd,
                swc_avg) %>%
  mutate(Date = as_date(date(TIMESTAMP)),
         Hour = hour(TIMESTAMP)) %>%
  filter(Hour <= 14, Hour > 11) %>%
  na.omit() %>%
  group_by(Year, Date, Plot) %>%
  summarise(soil_ec_avg = mean(ec_avg),
            ec_error = sd(ec_avg),
            soil_vwc_avg = mean(swc_avg)) %>%
  ungroup() -> soil_data

# analyze long-term BACI impact on EC
soil_data %>%
  filter(! Year %in% c(2022, 2023, 2024),
         month(Date) == 6) -> soil_BACI_data

# here Year is acting as "BA"
ec_2way <- aov(soil_ec_avg ~ Year*Plot,
                   data = soil_BACI_data)
#calculate estimated marginal means
ec_emm <- emmeans(ec_2way, ~ Plot|Year)
emm_2wayA <- as.data.frame(ec_emm)
#shows pairwise tests of 2021 vs 2025
contrasts <- contrast(ec_emm, interaction = "pairwise")
summary(contrasts)

#setting a width for offsets below
dodge_width <- 0.25

#plot of 21 vs 25 EMM with 95% CI for soil EC
ggplot(emm_2wayA, aes(x = Year, y = emmean, color = Plot)) +
  geom_point(size = 3, position = position_dodge(width = dodge_width)) +
  geom_errorbar(
    aes(ymin = lower.CL, ymax = upper.CL),
    width = 0.25,  
    position = position_dodge(width = dodge_width)) +
  geom_line(
    aes(group = Plot),
    position = position_dodge(width = dodge_width),
    linetype = "dashed") +
  scale_color_viridis_d(option = "mako",
                        begin = 0.3,
                        end = 0.7) +
  theme_minimal() +
  labs(
    y = "EMM",
    x = "Year",
    title = "Long-Term BACI for Soil EC") +
  theme(
    strip.text = element_text(face = "bold"),
    legend.title = element_text(face = "bold"))

```

EMM Pairwise comparisons for 2021 and 2025 demonstrates statistically significant differences between all plots, except post-treatment control vs saltwater comparison. Plot demonstrates large increase in soil EC for saltwater plot over time.

## VWC Plot & BACI

Soil volumetric water content at 15 cm depth comparison across plots from 2021-2025

```{r VWC, message = FALSE, warning = FALSE}

# same for moisture content
vwc_2way <- aov(soil_vwc_avg ~ Year*Plot,
               data = soil_BACI_data)

vwc_emm <- emmeans(vwc_2way, ~ Plot|Year)
emm_2wayB <- as.data.frame(vwc_emm)

contrasts <- contrast(vwc_emm, interaction = "pairwise")
summary(contrasts)

# VWC plot
ggplot(emm_2wayB, aes(x = Year, y = emmean, color = Plot)) +
  geom_point(size = 3, position = position_dodge(width = dodge_width)) +
  geom_errorbar(
    aes(ymin = lower.CL, ymax = upper.CL),
    width = 0.25,  
    position = position_dodge(width = dodge_width)) +
  geom_line(
    aes(group = Plot),
    position = position_dodge(width = dodge_width),
    linetype = "dashed") +
  scale_color_viridis_d(option = "mako",
                        begin = 0.3,
                        end = 0.7) +
  theme_minimal() +
  labs(
    y = "EMM",
    x = "Year",
    title = "Long-Term BACI for Soil VWC") +
  theme(
    strip.text = element_text(face = "bold"),
    legend.title = element_text(face = "bold"))
```

Pairwise comparison for 2021 and 2025; freshwater-saltwater VWC difference is not statistically significant for either year. 
BACI plot demonstrating increase in soil VWC EMM for all treatments. 

# And PAR?

## PAR plot & BACI

PAR averaged hourly for 2 weeks pre and post-flood. We do this at a finer temporal resolution to check that short-term changes in PAR are not a concern for our sapflow analysis.

```{r List of TEMPEST Events, message = FALSE, warning = FALSE}
#TEMPEST EVENTS
tempest_events <- bind_rows(
  tibble( Year = 2021, flood_start = "2021-06-12", flood_end = "2021-06-12"), #avg date = June 12
  tibble( Year = 2022, flood_start = "2022-06-22", flood_end = "2022-06-22"), #June 22
  tibble( Year = 2023, flood_start = "2023-06-06", flood_end = "2023-06-07"), #June 6, 7
  tibble( Year = 2024, flood_start = "2024-06-11", flood_end = "2024-06-13"), #June 11, 12, 13
  tibble( Year = 2025, flood_start = "2025-06-12", flood_end = "2025-06-12")) #same as 2021, no event

tempest_events %>%
  mutate(flood_start = ymd(flood_start),
         flood_end = ymd(flood_end)) %>%
  mutate (Year = as.factor(Year)) -> events

#window of data to look at for BACI analysis
window <- days(15)
```

```{r PAR, message = FALSE, warning = FALSE}

#select PAR data
data %>%
  mutate(Date = as.Date(TIMESTAMP),
         Hour = hour(TIMESTAMP), 
         Year = as.factor(Year)) %>%
  group_by(Date, Year) %>%
  filter(max(PAR) > 500,
    Hour <= 14, Hour > 11) %>% #midday
  dplyr::select(PAR, Date, Hour, Year) -> par

par %>%
  left_join(events, by = "Year") %>% 
  group_by(Year) %>%
  filter(
    Date >= flood_start - window,
    Date <= flood_end   + window
  ) %>%
  mutate(BA = ifelse(Date > flood_end, "After", "Before"),
         BA = as.factor(BA)) %>%
  group_by(Hour, Date, Year, BA, flood_start, flood_end) %>%
  summarise(par_avg = mean(PAR)) %>%
  ungroup() -> par_1

#plot
ggplot(par_1, aes(day(Date), par_avg, shape = BA)) +
  geom_point(size = 2.5, color = "darkgreen") + facet_grid("Year", scales = "free")

#test
par_test <- aov(par_avg ~ BA*Year,
                   data = par_1)

par_emm <- emmeans(par_test, ~ BA|Year)
par_contrasts <- contrast(par_emm, interaction = "pairwise")
summary(par_contrasts)
```

# Tulip Poplar BACI Analysis

## Whole growing season test

Are the time windows we've selected in the main analysis impacting our results? To test this we expand the time window for LITU BACI to the full growing season and full daylight hours of sapflow data.

```{r Whole Growing Season, message = FALSE, warning = FALSE}

#growing season from May 15th - October 1st
#I'm sure there's a better way to do this but
growing_szn <- bind_rows(
  tibble(Year = 2021, szn_start = "2021-05-15", szn_end = "2021-10-01",flood_start = "2021-06-12", flood_end = "2021-06-12"),
  tibble(Year = 2022, szn_start = "2022-05-15", szn_end = "2022-10-01", flood_start = "2022-06-22", flood_end = "2022-06-22"),
  tibble(Year = 2023, szn_start = "2023-05-15", szn_end = "2023-10-01", flood_start = "2023-06-06", flood_end = "2023-06-07"),
  tibble(Year = 2024, szn_start = "2024-05-15", szn_end = "2024-10-01", flood_start = "2024-06-11", flood_end = "2024-06-13"),
  tibble(Year = 2025, szn_start = "2025-05-15", szn_end = "2025-10-01", flood_start = "2025-06-12", flood_end = "2025-06-12"))

growing_szn %>%
  mutate(szn_start = ymd(szn_start),
         szn_end = ymd(szn_end),
         flood_start = ymd(flood_start),
         flood_end = ymd(flood_end)) -> season

#add in filtering step so that growing-season BACI has the same input data

data %>% #first we remove outlier values
mutate(Hour = hour(TIMESTAMP),
       Date = date(TIMESTAMP),
       doy = yday(Date)) %>%
  filter(doy > 99 & doy < 301, #wider growging than our test window
          Hour <= 19, Hour >= 7, #full day data
         `F` > 0, ! is.na(Species)) -> target_data #remove obviously unusable data

# Calculating thresholds for sapflow outliers.
thresholds <- target_data %>% 
  group_by(Species, Plot, Year) %>% #allows for annual, plot, and species specific values
  summarize(upper_threshold = quantile(`F` , 0.95))

# Remove values above that threshold
filtered_data <- target_data %>%
  left_join(thresholds, by = c("Species", "Plot", "Year")) %>%
  mutate(Outlier_F = ifelse(F > upper_threshold, "Outlier", "Non-Outlier")) %>%
  filter(Outlier_F == "Non-Outlier")

filtered_data %>%
  ungroup() %>%
  dplyr::select(Date, Year, Species, ID, Hour, Plot, `F` ,
                swc_avg, ec_avg, swc_sd, ec_sd, PAR) %>%
  left_join(season) %>%
  group_by(Date, Year) %>%
  filter(max(PAR) > 500,
         Date > szn_start & Date < szn_end,
         Plot != "Freshwater",
         Species == "Tulip Poplar") %>%
  ungroup() -> tulip_salt  

#sapflow, soil ec, soil vwc grouped by day and averaged
#should we change this to hourly averages for ec?
tulip_salt %>%
  mutate(BA = ifelse(Date > flood_end, "After", "Before"),
         Year = as.factor(Year),
         ID = as.factor(ID),
         BA = as.factor(BA),
         Plot = as.factor(Plot)) %>%
  group_by(Hour, Date, Plot, ID, Year, BA, flood_start, flood_end, szn_start, szn_end) %>%
  summarise(F_avg = mean(`F` , na.rm = TRUE),
            ec_avg = mean(ec_avg, na.rm = TRUE), 
            swc_avg = mean(swc_avg, na.rm = TRUE),
            n = n()) %>%
  ungroup() -> tsb_1

tsb_1 %>%
  group_by(Year) %>%
  mutate(Day = ifelse(BA == "Before",
                      - as.numeric(flood_start - Date),
                      as.numeric(Date - flood_end))) %>%
  mutate(BA = as.character(BA)) %>%
  mutate(BA = ifelse(Year == 2021, "Before", BA),
         BA = ifelse(Year == 2025, "Before", BA)) -> tsb_2
```

```{r BACI Model, message = FALSE, warning = FALSE}

model.int.og <- lmer(F_avg ~ BA*Plot +
                        (1|ID) + (1|Year) + (1|ID:Year),
                      data = tsb_2)

model.noint.og <- lmer(F_avg ~ BA + Plot +
                          (1|ID) + (1|Year) + (1|ID:Year),
                        data = tsb_2)

og.refdist <- PBrefdist(largeModel = model.int.og, 
                        smallModel = model.noint.og, 
                        nsim = 100)

og.compar <- PBmodcomp(largeModel = model.int.og, 
                       smallModel = model.noint.og,
                       ref = og.refdist)

og.compar
Anova(model.int.og, type = "III")
```

Both the likelihood ratio test and the parametric bootstrap test show strong statistical significance for the effect of BACI interaction term on observed differences in sapflow.

As a proxy for the increase in flooding intensity with each year, we include soil electrical conductivity into the model. Note that soil EC is an indicator of salt accumulation in soil from brackish water application. 

```{r BACI plus EC, message = FALSE, warning = FALSE}
model.int.ec <- lmer(F_avg ~ BA*Plot + ec_avg +
                      (1|ID) + (1|Year) + (1|ID:Year),
                      data = tsb_2)

model.noint.ec <- lmer(F_avg ~ BA + Plot + ec_avg +
                        (1|ID) + (1|Year) + (1|ID:Year),
                        data = tsb_2)

ec.refdist <- PBrefdist(largeModel = model.int.ec, 
                        smallModel = model.noint.ec, 
                        nsim = 100)

ec.compar <- PBmodcomp(largeModel = model.int.ec, 
                       smallModel = model.noint.ec,
                       ref = ec.refdist)
ec.compar
Anova(model.int.ec, type = "III")
```

Both the liklihood ratio test and the parametric boostrap test show that soil ec and the BACI interaction term have statistically significant effects on the observed differences in sapflow. When soil ec is accounted for in the model, the BACI interaction term is more significant than when only the interaction term is included. 


