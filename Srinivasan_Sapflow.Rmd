---
title: "Srinivasan_Sapflow"
author: "Radha V. Srinivasan & Kendalynn A. Morris"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

# TEMPEST sap flux density overview

```{r Load Packages, include=FALSE}

.packages = c("tidyr", "ggplot2", "dplyr", "lme4",
              "AICcmodavg", "MuMIn", "pbkrtest", "readr",
              "lubridate", "car", "parallel", "data.table",
              "blmeco", "lsmeans", "patchwork", "viridis",
              "forcats", "ggpmisc", "stringr", "e1071",
              "ggpubr", "ggstance", "zoo")
#Install CRAN packages (if not already installed)
.inst <- .packages %in% installed.packages()
if(length(.packages[!.inst]) > 0) install.packages(.packages[!.inst])

#Attach packages
sapply(.packages, require, character.only=TRUE)
```

```{r Load Data, message = FALSE, warning = FALSE}
#This will only work once raw data is downloaded and unzipped from ESS-DIVE
#doi:10.15485/2588618
#Following unzip, source files create_inventory.R and create_full_timeseries_plus_abiotic.R
#these files calculate sapflux density

#This only needs to be done once

data <- readRDS("Sapflow_BACI.rds")

```

```{r Sapflow Visual, message = FALSE, , warning = FALSE}

#a quick check to make sure the data are all present and accounted for
#TODO find source of NAs for species
#TODO bring in second half of 2025 sapflow data

data %>% #first we remove outlier values
mutate(Hour = hour(TIMESTAMP),
       Date = date(TIMESTAMP),
       doy = yday(Date)) %>%
  filter(doy > 99 & doy < 301, #growing season
         Hour <= 14, Hour > 11, #midday
         F > 0, ! is.na(Species)) -> target_data #remove obviously unusuable data

# Calculating thresholds for sapflow outliers.
thresholds <- target_data %>% 
  group_by(Species, Plot, Year) %>% #allows for annual, plot, and species specific values
  summarize(upper_threshold = quantile(`F`, 0.95))

# Remove values above that threshold
filtered_data <- target_data %>%
  left_join(thresholds, by = c("Species", "Plot", "Year")) %>%
  mutate(Outlier_F = ifelse(F > upper_threshold, "Outlier", "Non-Outlier")) %>%
  filter(Outlier_F == "Non-Outlier")

#summarize for plotting
filtered_data %>%
  group_by(Plot, Species, Date) %>%
  summarise(F_avg = mean(`F`, na.rm = TRUE)) -> sf_plot_avg

ggplot(sf_plot_avg) + 
  geom_point(aes (x = Date, y = F_avg, color = Species)) + 
  facet_wrap(~Plot, ncol = 1, scales = "fixed") + 
  scale_color_viridis_d(option = 'D', begin = .25, end = .8) +
  theme_light() +
  labs(y = "Avg Sap Flux Density cm3/cm2/s", x = "Date",
       title = "Sap Flux Density Averaged Daily, 11 AM - 2 PM")

```

```{r TEMPEST Events, message = TRUE}
#TEMPEST EVENTS
tempest_events <- bind_rows(
  tibble( Year = 2021, flood_start = "2021-06-12", flood_end = "2021-06-12"),
  #average date = June 12
  tibble( Year = 2022, flood_start = "2022-06-22", flood_end = "2022-06-22"), #June 22
  tibble( Year = 2023, flood_start = "2023-06-06", flood_end = "2023-06-07"), #June 6, 7
  tibble( Year = 2024, flood_start = "2024-06-11", flood_end = "2024-06-13"), #June 11, 12, 13
  tibble( Year = 2025, flood_start = "2025-06-12", flood_end = "2025-06-12"))
#average date = June 12

tempest_events %>%
  mutate(flood_start = ymd(flood_start),
         flood_end = ymd(flood_end)) -> events

#window of data to look at for BACI analysis
window <- days(15)

```

# Long-Term BACI Test

Sapflow sensors were installed in 2020 and collected data throughout the growing season of 2021, creating a full year of pre-treatment (Before) data. No TEMPEST treatment occured in 2025, creating a full growing season of post-treatment (After) data, allowing us to test the effect of three consecutive years of progressively intensive inundation events.

```{r Long-Term BACI, include = FALSE}

#making our data frame just a little smaller
filtered_data %>%
  dplyr::select(Year, Species, ID, TIMESTAMP, Plot, `F`,
                ec_avg, swc_avg, TEMP, PAR) %>%
  mutate(Date = as_date(date(TIMESTAMP)),
         doy = yday(Date),
         Hour = hour(TIMESTAMP)) %>%
  ungroup() -> BACI_data

BACI_data %>%
  mutate(Year = as.factor(Year),
         ID = as.factor(ID),
         Plot = as.factor(Plot)) %>%
  group_by(doy, Date, Plot, Species, ID, Year) %>%
  #filter(max(PAR) > 500) %>%
  #ideally we would remove cloudy days, but currently don't have PAR data for 2021
  summarise(F_avg = mean(`F`, na.rm = TRUE),
            soil_ec_avg = mean(ec_avg), 
            soil_vwc_avg = mean(swc_avg),
            par_avg = mean(PAR),
            temp_avg = mean(TEMP),
            n = n()) %>%
  ungroup() -> avg_BACI_data


# List of species and plots
species_list <- c("Red Maple", "Tulip Poplar", "Beech")
plot_list <- c("Control", "Freshwater", "Saltwater")

# Loop through each species and plot combination to generate plots
for (species in species_list) {
  for (plot in plot_list) {
    avg_BACI_data %>%
      filter(Plot == plot, Species == species) %>%
      ggplot(aes(x = doy, y = F_avg, color = Year)) +
      geom_point() +
      facet_wrap(. ~ ID, ncol = 3, scales = "fixed") +
      scale_color_viridis_d(option = 'D', begin = .25, end = .8) +
      theme_light() +
      labs(
        y = "Midday Sap Flux Density cm3/cm2/s",
        x = "Day of Year",
        title = paste(" Averaged Sap Flux Density,", species, "-", plot)
      ) -> p
    
    print(p)
  }
}

#based on these plots excluding the following trees:
# C8, C19

avg_BACI_data %>%
  filter(! Year %in% c(2022, 2023, 2024),
         ! ID %in% c("C8", "C19"),
         month(Date) == 6) -> final_BACI_data #more data would be advantageous, but
#currently June is the latest growing-season month we have '25 data for

final_BACI_data$Species <- factor(final_BACI_data$Species, 
                           levels = c("Red Maple", "Beech", "Tulip Poplar"),
                           labels = c("ACRU", "FAGR", "LITU"))

#base model, here Year is acting as "BA"
#and we're allowing all levels of plot and species to interact
#random effect of ID allows for different trees to have different intercepts
model_3way <- lmer(F_avg ~ Year*Plot*Species + (1|ID),
                   data = final_BACI_data)
#calculate estimated marginal means
model_emm <- emmeans(model_3way, ~ Species|Plot*Year)
emm_3way <- as.data.frame(model_emm)
#shows pairwise tests of 2021 vs 2025 data for each species x plot group
contrasts <- contrast(model_emm, interaction = "pairwise", by = c("Species", "Plot"))

#setting a width for offsets below
dodge_width <- 0.25

```

```{r plot Long-Term BACI}

#species by plot contrasts
summary(contrasts)

#plot of 21 vs 25 EMM with 95% CI
ggplot(emm_3way, aes(x = Year, y = emmean, color = Plot)) +
  facet_grid(~ Species) +
  geom_point(size = 3, position = position_dodge(width = dodge_width)) +
  geom_errorbar(
    aes(ymin = lower.CL, ymax = upper.CL),
    width = 0.25,  
    position = position_dodge(width = dodge_width)) +
  geom_line(
    aes(group = interaction(Species, Plot)),
    position = position_dodge(width = dodge_width),
    linetype = "dashed") +
    scale_color_viridis_d(option = "mako",
                        begin = 0.3,
                        end = 0.7) + theme_bw() +
  theme_minimal() +
  labs(
    y = "Estimated Marginal Mean (Sapflow)",
    x = "Year",
    title = "Long-Term BACI") +
  theme(
    strip.text = element_text(face = "bold"),
    legend.title = element_text(face = "bold"))

```

## Interpreting long-term contrasts

Tulip poplar noticeably increases in all plots over time, but SW plot lags behind FW and control.
Red maple shows little change over time, with trend in FW (slight decrease) differing from that in SW (slight increase, both NS).
Beech increases strongly in FW over time, and declines strongly in control.

Below we dig into trends in Beech and Tulip poplar in greater detail.

```{r dig into FAGR responses}

avg_BACI_data %>%
  filter(Year == 2025,
         month(Date) == 6,
         Species == 'Beech') -> FAGR_data1

FAGRmodel1 <- lmer(F_avg ~ Plot + (1|ID),
     data = FAGR_data1)
FAGR_emm1 <- emmeans(FAGRmodel1, ~ Plot)
contrast(FAGR_emm1, interaction = "pairwise")

avg_BACI_data %>%
  filter(Species == "Beech",
         Plot == "Control",
         month(Date) == 6) %>%
  mutate(Year = factor(Year,
                       levels = c("2025", "2024", "2023", "2022", "2021")
                       ))-> FAGR_data2

FAGRmodel2 <- lmer(F_avg ~ Year + (1|ID),
     data = FAGR_data2)
FAGR_emm2 <- emmeans(FAGRmodel2, ~ Year)
contrast(FAGR_emm2, interaction = "pairwise")

```

Beech trees are clearly increasing sapflow in response to FW treatments, but the strong treatment effects are also due to low sapflow in the Control plot. Notably Control-Beech sapflow in 2025 is lower than any other data collection year. It is unknown at this time why Beech trees in the Control plot had such low sapflow in 2025.

```{r dig into LITU responses}

avg_BACI_data %>%
  filter(Year == 2025,
         month(Date) == 6,
         Species == 'Tulip Poplar') -> LITU_data1

LITUmodel1 <- lmer(F_avg ~ Plot + (1|ID),
     data = LITU_data1)
LITU_emm1 <- emmeans(LITUmodel1, ~ Plot)
contrast(LITU_emm1 , interaction = "pairwise")

avg_BACI_data %>%
  filter(Species == "Tulip Poplar",
         Plot == "Control",
         month(Date) == 6) %>%
  mutate(Year = factor(Year,
                       levels = c("2025", "2024", "2023", "2022", "2021")
                       ))-> LITU_data2

LITUmodel2 <- lmer(F_avg ~ Year + (1|ID),
     data = LITU_data2)
LITU_emm2 <- emmeans(LITUmodel2, ~ Year)
contrast(LITU_emm2, interaction = "pairwise")

```

Tulip poplar has a much clearer pattern with the Control and SW plot differing from each other after 3 years of inundation treatments and steady increase in sapflow over the measurement period. From here on we focus on Tulip poplar (LITU) and the impact of saltwater on its sapflow.

# LITU BACI


## Two weeks Before/After events


Selecting data from Tulip poplars in treatment years and excluding the Freshwater plot.

```{r Select LITU and SW plot data, message = FALSE, warning = FALSE}
#currently this occurs in the 3 chunks
#may be possible to streamline
filtered_data %>%
  dplyr::select(Year, Species, ID, TIMESTAMP, Plot, `F`,
                ec_avg, swc_avg, TEMP, PAR) %>%
  mutate(Date = as_date(date(TIMESTAMP)),
         Hour = hour(TIMESTAMP)) %>%
  group_by(Date, Year) %>%
  filter(max(PAR) > 500) %>%
  ungroup() %>%
  left_join(events) %>%
  group_by(Year) %>%
  mutate(data_start = flood_start - window,
         data_end = flood_end + window) %>%
  filter(Date > data_start & Date < flood_start |
         Date < data_end & Date > flood_end,
         Plot != "Freshwater",
         Species == "Tulip Poplar",
         
         ) %>%
  ungroup() -> tulip_salt

tulip_salt %>%
  group_by(Year) %>%
  mutate(BA = ifelse(Date > flood_end, "After", "Before"),
         Year = as.factor(Year),
         ID = as.factor(ID),
         BA = as.factor(BA),
         Plot = as.factor(Plot)) %>%
  group_by(Date, Plot, Species, ID, Year, BA, flood_start, flood_end) %>%
  summarise(F_avg = mean(`F`, na.rm = TRUE),
            soil_ec_avg = mean(ec_avg), 
            soil_vwc_avg = mean(swc_avg),
            par_avg = mean(PAR),
            temp_avg = mean(TEMP),
            n = n()) %>%
  ungroup() -> tsb_1

tsb_1 %>%
  filter(! is.na(tsb_1$Species),
         ! Year %in% c(2021, 2025)) %>%
  group_by(Year) %>%
  mutate(Day = ifelse(BA == "Before",
                      - as.numeric(flood_start - Date),
                      as.numeric(Date - flood_end))
         ) %>%
  mutate(BA = as.character(BA),
         # BA = ifelse(Year == 2021, "Before", BA),
         # BA = ifelse(Year == 2025, "After", BA)
         ) -> tsb_2

ggplot(tsb_2, aes(Day, F_avg, color = ID, shape = BA)) +
  geom_point(size = 2.5) + facet_grid(Plot~Year, scales = "free")
```

```{r Normality, message = FALSE}
#here we check if our response variable is normally distributed
#RV = daily averaged midday sap flux density per tree
current_skewness <- skewness(tsb_2$F_avg)
print(paste("Current Skewness:", current_skewness))

# Logarithmic Transformation
log_transformed_response <- log(tsb_2$F_avg)

# Square Root Transformation
sqrt_transformed_response <- sqrt(tsb_2$F_avg)

# Inverse Transformation
inv_transformed_response <- 1 / tsb_2$F_avg

log_skewness <- skewness(log_transformed_response)
sqrt_skewness <- skewness(sqrt_transformed_response)
inv_skewness <- skewness(inv_transformed_response)

print(paste("Log Transformation Skewness:", log_skewness))
print(paste("Square Root Transformation Skewness:", sqrt_skewness))
print(paste("Inverse Transformation Skewness:", inv_skewness))

ggplot(tsb_2, aes(F_avg)) + geom_histogram(fill = '#31688EFF') +
  facet_grid(Plot~.) +
  labs(y = NULL, x = "Average Sapflow", title = "Untransformed Data")

```


## Progressive Analysis



We follow the workflow developed by Pardini et al 2018 [pardini_link](https://doi.org/10.1111/rec.12678)  and start with the following linear mixed model:

F_avg \~ BA + Plot + BA\*Plot + (1\|ID) + (1\|Year) + (1\|ID:Year)

In which 'Plot' is the control/impact treatment effect (the Control and Saltwater plots for TEMPEST), 'BA' is the before and after treatment effect (pre/post flooding events), and tree ID and Year are random effects.

\*Note that although, flooding intensity increases each year, we ignore this effect for now.

First, test for the statistical significance of the final term (1\|ID:Year), the interaction of the ID and Year random effects, using an AIC comparison.

```{r Pardini et al 2018, warning = FALSE}
Cand.set <- list()

Cand.set[[1]] <- lmer(F_avg ~ BA + Plot  + BA*Plot +
                         (1|ID) + (1|Year),
                       data = tsb_2 )
model.noint <- Cand.set[[1]]

Cand.set[[2]] <- lmer(F_avg ~ BA + Plot + BA*Plot +
                         (1|ID) + (1|Year) +
                         (1|ID:Year),
                       data = tsb_2 )
model.int <- Cand.set[[2]]

AIC.res.table <- aictab(cand.set = list(Cand.set[[1]], Cand.set[[2]]), 
                        modnames = paste0("Cand.set_", c(1,2)), 
                        second.ord = TRUE)
AIC.res.table
```

Choose the model with the lowest AICc value (i.e. largest negative value); this suggests that the second model, which includes the random effects interaction term, is a better fit for our data.


## Create and test BACI models




We now test the impact of the BACI term in our existing model by looking at the explanatory power of the model with and without the interaction between BA and CI (plot): 
```{r message = FALSE, warning = FALSE}
model.int.og <- lmer(F_avg ~ BA*Plot +
                        (1|ID) + (1|Year) + (1|ID:Year),
                      data = tsb_2 )

model.noint.og <- lmer(F_avg ~ BA + Plot +
                          (1|ID) + (1|Year) + (1|ID:Year),
                        data = tsb_2 )

og.refdist <- PBrefdist(largeModel = model.int.og, 
                        smallModel = model.noint.og, 
                        nsim = 100)

og.compar <- PBmodcomp(largeModel = model.int.og, 
                       smallModel = model.noint.og,
                       ref = og.refdist)

og.compar
Anova(model.int.og, type = "III")
```

The likelihood ratio test indicates a weak effect of the BACI interaction term.

As a proxy for the increase in flooding intensity with each year, we include soil electrical conductivity into the model. Note that soil EC is an indicator of salt accumulation in soil from brackish water application: 

```{r BACI plus EC, message = FALSE, warning = FALSE}
model.int.ec <- lmer(F_avg ~ BA*Plot + soil_ec_avg +
                      (1|ID) + (1|Year) + (1|ID:Year),
                      data = tsb_2 )

model.noint.ec <- lmer(F_avg ~ BA + Plot + soil_ec_avg +
                        (1|ID) + (1|Year) + (1|ID:Year),
                        data = tsb_2 )

ec.refdist <- PBrefdist(largeModel = model.int.ec, 
                        smallModel = model.noint.ec, 
                        nsim = 100)

ec.compar <- PBmodcomp(largeModel = model.int.ec, 
                       smallModel = model.noint.ec,
                       ref = ec.refdist)
ec.compar
Anova(model.int.ec, type = "III")
```

We now see that the BACI interaction term and soil ec fixed effect have strong explanatory power via the likelihood ratio and parametric bootstrap. 


# Plots

```{r EC Plot, message = FALSE, warning = FALSE}
# isolate soil data and summarize
data %>%
  dplyr::select(Year, TIMESTAMP, Plot,
                ec_avg, ec_sd,
                swc_avg) %>%
  mutate(Date = as_date(date(TIMESTAMP)),
         Hour = hour(TIMESTAMP)) %>%
  filter(Hour <= 14, Hour > 11) %>%
  na.omit() %>%
  group_by(Year, Date, Plot) %>%
  summarise(soil_ec_avg = mean(ec_avg),
            ec_error = sd(ec_avg),
            soil_vwc_avg = mean(swc_avg)) %>%
  ungroup() -> soil_data

# created rolled mean of EC for plotting
soil_data %>%
  dplyr::select(Year, Plot, Date, soil_ec_avg) %>%
  group_by(Plot) %>%
  arrange(Date) %>%
  mutate(ec_rolled = rollmean(soil_ec_avg,
                              k = 3,
                              align = "center",
                              fill = NA)) -> ec_rolled
# pretty plot of EC data
soil_data %>%
  filter(Date > "2021-04-01") %>%
  #optional, gets rid of little squiggle at the beginning of '21
ggplot(aes(Date, soil_ec_avg, color = Plot)) +
  geom_point(alpha=0.5) +
  geom_errorbar(aes(ymin = soil_ec_avg - ec_error,
                    ymax = soil_ec_avg + ec_error)) +
  geom_line(data = ec_rolled %>%
              filter(Date > "2021-04-01"),
            aes(Date, ec_rolled)) +
  scale_color_viridis_d(option = "mako",
                        begin = 0.3,
                        end = 0.7) + theme_bw() +
  theme(legend.position = "bottom") +
  ylab("Soil Electrical Conductivity (\u03bcS cm\u207b\u00b9)")

```

```{r LITU BACI boxplot}

tsb_2 %>%
  mutate(BA = factor(BA, levels = c("Before", "After"))) %>%
ggplot(aes(y=F_avg)) +
  geom_boxplot_pattern(aes(pattern = BA, fill = Plot), alpha = 0.8 ) +
  facet_wrap(Year~.) + scale_fill_viridis_d(begin = 0.15, end = 0.8) +
  labs(y = "Midday Sap Flow (cm³ cm⁻² s⁻¹)") +
  theme_bw() + theme(axis.ticks.x.bottom = element_blank(),
                     axis.text.x.bottom = element_blank()) +
    guides(fill = guide_legend(title = "Plot"),
           pattern = guide_legend(title = "Before-After"))
  

```

```{r overlay plot}

filtered_data %>%
  ungroup() %>%
  mutate(Year = as.factor(Year)) %>%
  filter(
    Year == "2021" & (Species != "Tulip poplar" | (Species == "Tulip poplar" & `F` < 0.002))
  ) %>%
  group_by(Plot, Species, ID, Date, Year) %>%
  summarise(F_avg = mean(`F`, na.rm = TRUE)) %>%
  ungroup() -> y21

filtered_data %>%
  ungroup() %>%
  mutate(Year = as.factor(Year)) %>%
  group_by(Year, Date) %>%
  filter(max(PAR) > 500) %>%
  group_by(Plot, Species, ID, Date, Year) %>%
  summarise(F_avg = mean(`F`, na.rm = TRUE)) %>% 
  ungroup() %>%
  bind_rows(y21) -> plot_data
  
plot_data %>%
  group_by(Year, Plot, Species) %>%
  arrange(Date) %>%
  mutate(f_roll = zoo::rollmean(F_avg, 100, na.rm = TRUE,
                                align = "center", fill = NA)) -> rolled_data

ggplot() +
  geom_line(data = rolled_data, aes(y = f_roll, x = yday(Date), color = Year, group = Year),
            linewidth = 1.5) +
  geom_jitter(data = plot_data, aes(y = F_avg, x = yday(Date), color = Year, group = Year), alpha = 0.1, size = 0.8) +
  facet_grid(Species ~ Plot, scales="free") +
  scale_color_viridis_d(option = 'D', begin = 0.1, end = 0.9) +
  labs(y = expression ("Midday Sap Flow, cm"^3* " s"^-1),
       x = expression(paste("Day of Year"))) +
  theme_bw() + theme(legend.position="bottom", element_text(size = 14))

```
