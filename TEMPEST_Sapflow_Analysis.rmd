---
title: "TEMPEST Sapflow Initial Analysis"
author: "Radha Srinivasan"
date: "2024-07-31"
output: 
  html_document:
    toc: true 
    toc_float: true 
    code_folding: hide
---

## Background

This is a summary of the pipeline I have used over the past summer to analyze TEMPEST sap flow data. 

### Sap Flux Density Calculations

This code currently calculates and graphs whole-tree sap flux density from January 1, 2021 - May 2, 2024. 

Raw sap flow measurements are recorded in terms of difference in voltage (mV) between the two probes; due to the nature of the equations used (Granier 1985) voltage difference can be thought of as interchangeable with temperature difference.

#### Notes on vernacular:

Sap flow velocity (F) is used to describe the point/unscaled sap flow measurement, and sap flux density (Fd) would describe sap flow over a certain area (in this case, sapwood area of the tree).

## Data Wrangling

Load in our packages:

```{r message = FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(stringr)
```

Load in our data:

1)  TEMPEST site data: Sapflow (mV) at 2.5 cm , soil volumetric water content($m^3 / m^3$) at 15 cm 
2)  GCReW site data: Photosynthetically active radiation ($\mu mol/m^2 \cdot s$), air temperature ($C$)
2)  Species ID, DBH (cm)

```{r}
tmp_full <- readRDS("tmp_full.rds")
gcw_full <- readRDS("gcw_full.rds")
species <- readRDS("dbh.rds")
```

Specify pre and post TEMPEST flood weeks (including 2 weeks in June 2021):

```{r}
weeks_start <- c("2022-06-15", "2022-06-23", "2023-05-30", "2023-06-08", "2021-06-06", "2021-06-13")
weeks_end <- c("2022-06-21", "2022-06-29", "2023-06-05", "2023-06-14", "2021-06-12", "2021-06-19")
weeks_start<- as_date(weeks_start)
weeks_end<- as_date(weeks_end)
```


Tidy up data- match variable names between dataframes, remove outliers (sapflow voltage differences should be between 0.01 and 0.7).

```{r}
tmp_full %>%
  mutate(Plot = substr(Plot,1,1),
         Plot = case_when(Plot == "C" ~ "Control",
                          Plot == "F" ~ "Freshwater",
                          Plot == "S" ~ "Saltwater", )) -> tmp_full
species %>%
  mutate(Species = substr(spp,1,4),
         Species = case_when(spp == "ACRU" ~ "Red Maple",
                             spp == "LITU" ~ "Tulip Poplar",
                             spp == "FAGR" ~ "Beech")) %>%
  select(Plot, Sapflux_ID, Species) %>%
  filter(!grepl("D", Sapflux_ID)) -> species

sapflow <- tmp_full %>% 
  filter(Instrument == "Sapflow",
         Value >= 0.01, Value <=0.7) %>%
  select(Plot, TIMESTAMP, Sensor_ID, Value) %>%
  mutate(sapflow_2.5cm = Value) %>% 
  mutate(Date = date(TIMESTAMP))

```

Match species name with sapflow measurements and ID, create new dataframe with select variables:

```{r}
sapflow_sp <- 
  merge(species, sapflow, by.x = c("Sapflux_ID", "Plot"), by.y = c("Sensor_ID", "Plot"), all.x = TRUE, all.y = TRUE)

mutate(sapflow_sp, ID = Sapflux_ID) -> sapflow_sp
```

## dTmax Calculations

Calculate dTmax (the maximum difference in voltage, i.e. the minimum sapflow) over a 24 hour period. Note: This value was initially calculated between the hours of midnight and 5 am, but this failed to account for instances of low sapflow during the day, so the whole 24 hour period was used. 

```{r message = FALSE}
sapflow_sp %>% 
  mutate(Date = date(TIMESTAMP)) %>%
  group_by(Date, Plot, Species, ID) %>% 
  summarise(dTmax = max(Value, na.rm = TRUE), 
            dTmax_time = TIMESTAMP[which.max(Value)])-> sapflow_dtmax
```

Double check that our calculated dTmax values indeed match the value of lowest sapflow during the day. Graph voltage difference and dTmax on the y-axis and timestamp on the x-axis (in one treatment for simplicity):

```{r}
sapflow_dtmax %>% 
  filter(Plot == "Control") %>% 
  ggplot(aes(x = TIMESTAMP, y = Value, group = Species, color= as.factor(Species))) + 
  geom_line() + 
  geom_point(data = filter(sapflow_dtmax, Plot == "Control"), aes(x = dTmax_time, y = dTmax), color = "black") +
  facet_wrap(ID~Plot, scales = "free") 
```

We should expect to see dTmax values on the peaks of the voltage differences for each day. Looks good!

## F_d Calculations

Convert voltage difference to sap flux density ($F_d$,$m^3/m^2 \cdot s$ i.e. m/s) using Granier 1985 equation. 

$$ F_{d}  = \alpha K^{b} $$ Constants alpha ($m^3/s^3$) and b were experimentally determined by Granier and depend on the power of the heat probe (0.2 W).

$$ F_{d}  = 118.99 \cdot 10^{-6} \cdot (\frac{\Delta T_{max}}{\Delta T}- 1)^{1.231}$$ 

Implement in dataframe:

```{r}

sapflow_sp %>% 
  left_join(sapflow_dtmax, by = c("Plot", "Species", "ID", "Date")) %>% 
  mutate(Fd = ((0.00011899 * (((dTmax / Value) - 1)))^1.231))  -> sfd_data
```

Graph newly calculated values of sap flux density with dTmax to check our calculations:

```{r}
ggplot(data = filter(sfd_data), aes(x = TIMESTAMP, y = (Fd), group = Species, color = as.factor(Species))) + 
  geom_line() + 
  geom_point(data = sapflow_dtmax, aes(x = dTmax_time, y = dTmax), color = "black") +
  facet_wrap(~Plot, ncol = 1) 
```

dTmax is the highest voltage difference (i.e. the lowest sap flux density), so we should see our dTmax points at the lowest points of the Fd values. Looks good!

## Allometric Equations

Scale our Fd values to be representative of the whole tree using area of sapwood (active sap-conducting xylem) based on Lu 2004 equation.

First, estimate sapwood area for each tree using species-specific allometric equations from Brantley 2016. Equations follow the format y = a\* D\^b, with experimentally determined coefficients for each species. Note: Brantley did not include coefficients specific to American Beech, so an equation for diffuse-porous trees is used. Find a beech-specific equation if this isn't sufficient?

```{r}
inventory <- readRDS("dbh.rds")

inventory %>%
  select(Tag, Tree_Code, Species, 
         #DBH_2019, DBH_2020, DBH_2021, DBH_2022, DBH_2023, 
         DBH_2024) -> dbh

dbh %>%
  mutate(Species = substr(Species,1,4),
         Species = case_when(Species == "ACRU" ~ "Red Maple",
                          Species == "LITU" ~ "Tulip Poplar",
                          Species == "FAGR" ~ "Beech")) %>%
  mutate(SA_2024 = case_when(
    Species == "Red Maple" ~ (0.5973*(DBH_2024)^2.0743),
    Species == "Tulip Poplar" ~ (0.8086*(DBH_2024)^1.8331 ),
    Species == "Beech" ~ (0.8198*(DBH_2024)^1.8635)
  )) -> dbh

```

Use sapwood areas to scale Fd to whole tree using Lu 2004 equation: $$ F_{tot} = F_{d} / SA $$

```{r}
scaled <- merge(sfd_data, dbh, by.x = c("ID", "Species"), by.y = c("Tree_Code", "Species"), all.x = TRUE)

scaled %>%
  mutate(F_tot = Fd * SA_2024) -> scaled
```

Find hourly period of maximum Fd:

```{r message = FALSE}
scaled %>% 
  group_by(Date, Plot, Species, ID) %>% 
  summarise(Fdmax = max(Fd, na.rm = TRUE),
            Fdmax_time = TIMESTAMP[which.max(Fd)]) -> maxFd_time

ggplot(maxFd_time, aes(x = Fdmax_time)) + 
  geom_histogram() + 
  labs(x = "Hour", y = "Frequency", title = "Maximum Fd per hour")
 
```

Peak hours seem to be between 11 AM and 12 PM. Let's double check if it varies seasonally:

```{r message = FALSE}
ggplot(maxFd_time, aes(x = hour(Fdmax_time), fill = Species)) +
  geom_histogram() + ggtitle("Monthly Max Fd Time")+
  facet_wrap(.~month(Fdmax_time))
```

Not much seasonal variation.

Graph whole tree flux for 11-12 AM over the last two weeks of April, averaged by plot and species. Note: These are averaged values for every 15 minutes from 11-12 AM.

```{r message = FALSE}

scaled %>% 
  filter(Hour >= 11, Hour <= 12) %>% 
  group_by(Plot, Date, Species) %>% 
  summarise(Ftot_avg = mean(F_tot, na.rm = TRUE),
            Ftot_error = sd(F_tot, na.rm = TRUE)) %>%
  mutate(Ftot_avg = round(Ftot_avg, digits = 3),
         Ftot_error = round(Ftot_error, digits = 3)) -> scaled_plot_avg

ggplot(scaled_plot_avg) + 
  geom_line(aes (x = Date, y = Ftot_avg, color = Species)) + 
  geom_errorbar(aes(ymin = Ftot_avg - Ftot_error, ymax = Ftot_avg + Ftot_error,
                    x = Date, color = Species)) + 
  facet_wrap(~Plot, ncol = 1)
  ggsave("Ftot_weeklyplot.jpeg")
  
```



ANOVA test to determine if difference in Fd of different treatments and species are statistically significant and a summarizing box plot (We can assume species and plot are correlated with each other, as different species likely vary under different treatments):

```{r}
scaled %>%
  filter(Hour <= 12, Hour >= 11, Date >= "2024-04-24") -> scaled_pm

sapflow_aov <- aov(F_tot ~ Species * Plot, data = scaled_pm)

summary(sapflow_aov)

ggplot(scaled_pm) + 
  geom_boxplot(aes (x = Plot, y = F_tot, fill = Species)) +
  scale_x_discrete(labels = c("C" = "Control",
                              "F" = "Freshwater",
                              "S" = "Saltwater")) +
  theme_light()

```

The p-value is \<\<0.05; the differences in Fd between species and treatments are statistically significant. We can see variation between species and within treatments, as well as between treatments for beech and tulip poplar. Red maple seems fairly consistent in mean and variance between treatments.

## Abiotic Factors 

For correlations with abiotic factors, let's isolate the weeks pre and post TEMPEST flood events: 

